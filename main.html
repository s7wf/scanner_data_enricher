<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Security Data Enrichment Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        .blinking-cursor {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { border-right-color: transparent; }
            50% { border-right-color: #fbbf24; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">Live Security Data Enrichment Pipeline</h1>
            <p class="text-lg text-gray-400">From Raw JSON to Actionable Intelligence</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Controls and Status -->
            <div class="lg:col-span-1 bg-gray-800 rounded-2xl shadow-2xl p-6 h-fit">
                <h2 class="text-2xl font-semibold text-white border-b border-gray-600 pb-3 mb-4">Controls</h2>
                
                <!-- File Input -->
                <div class="mb-4">
                    <label for="file-upload" class="block text-sm font-medium text-gray-300 mb-2">1. "Upload" Rapid7 JSON Data</label>
                    <div id="file-drop-area" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md cursor-pointer hover:border-indigo-400 transition">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                            </svg>
                            <div class="flex text-sm text-gray-400">
                                <p id="file-name-display" class="pl-1">your_data.json (Embedded)</p>
                            </div>
                            <p class="text-xs text-gray-500">Click or drag file here</p>
                        </div>
                    </div>
                     <input id="file-upload" type="file" class="hidden" accept=".json">
                </div>
                
                <!-- API Key Input -->
                <div class="mb-6">
                    <label for="api-key" class="block text-sm font-medium text-gray-300">2. AbuseIPDB API Key (Optional)</label>
                    <input type="text" id="api-key" placeholder="Demo runs without a key" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm transition">
                </div>

                <!-- Action Button -->
                <button id="start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500">
                    Start Enrichment
                </button>
                
                <!-- Status Console -->
                <div class="mt-6">
                     <h3 class="text-lg font-semibold text-white mb-2">Live Status</h3>
                     <div id="status-console" class="w-full h-48 bg-black rounded-lg p-3 text-sm font-mono overflow-y-auto text-amber-300 border border-gray-700">
                         <p>> Console ready. Press start to begin demo.<span class="blinking-cursor border-r-2 border-amber-300"></span></p>
                     </div>
                </div>
            </div>

            <!-- Right Column: Dashboard -->
            <div class="lg:col-span-2">
                <div id="dashboard" class="bg-gray-800 rounded-2xl shadow-2xl p-6 hidden">
                    <div class="flex justify-between items-center border-b border-gray-600 pb-3 mb-6">
                        <h2 class="text-2xl font-semibold text-white">Enrichment Dashboard</h2>
                        <button id="download-csv-btn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition transform hover:scale-105">
                            Download CSV
                        </button>
                    </div>
                    <div id="dashboard-charts" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-900 p-4 rounded-lg"><div class="chart-container"><canvas id="severityChart"></canvas></div></div>
                        <div class="bg-gray-900 p-4 rounded-lg"><div class="chart-container"><canvas id="topCvesChart"></canvas></div></div>
                        <div class="bg-gray-900 p-4 rounded-lg"><div class="chart-container"><canvas id="topAssetsChart"></canvas></div></div>
                        <div class="bg-gray-900 p-4 rounded-lg"><div class="chart-container"><canvas id="topPortsChart"></canvas></div></div>
                    </div>
                </div>
                <div id="welcome-mat" class="flex items-center justify-center bg-gray-800 rounded-2xl shadow-2xl p-6 min-h-[500px]">
                    <div class="text-center">
                        <svg class="mx-auto h-24 w-24 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        <h3 class="mt-4 text-2xl font-semibold text-white">Your Dashboard Awaits</h3>
                        <p class="mt-2 text-gray-400">Click "Start Enrichment" to process the data and generate your interactive security report.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- UPDATED MOCK DATA ---
    // This data is now in a format the application expects, converted from the file you provided.
    const compatibleJsonData = {
      "assets": [
        {
          "ip": "198.51.100.24",
          "host-name": "webserver01.example.com",
          "os-certainty": "Linux Ubuntu 22.04",
          "vulnerabilities": [
            {
              "id": "CVE-2023-4567",
              "title": "Apache HTTP Server Path Traversal",
              "severity": 7.5,
              "port": 443,
              "protocol": "TCP",
              "proof": "A path traversal vulnerability in Apache HTTP Server allows an attacker to read files outside the root directory."
            },
            {
              "id": "CVE-2022-31813",
              "title": "OpenSSH Username Enumeration",
              "severity": 5.3,
              "port": 22,
              "protocol": "TCP",
              "proof": "A vulnerability in some versions of OpenSSH allows remote attackers to enumerate valid usernames."
            }
          ]
        },
        {
          "ip": "203.0.113.50",
          "host-name": "db-server.internal.corp",
          "os-certainty": "Windows Server 2019",
          "vulnerabilities": [
            {
              "id": "CVE-2021-34527",
              "title": "Windows Print Spooler RCE (PrintNightmare)",
              "severity": 8.8,
              "port": 445,
              "protocol": "TCP",
              "proof": "A critical remote code execution vulnerability exists in the Windows Print Spooler service."
            }
          ]
        },
        {
          "ip": "192.168.1.100",
          "host-name": "dev-workstation-05",
          "os-certainty": "macOS Sonoma",
          "vulnerabilities": []
        }
      ]
    };
    
    let jsonData = compatibleJsonData;
    let enrichedResults = [];
    const ipCache = {};
    const cveCache = {};
    const charts = {};

    // --- DOM Elements ---
    const startBtn = document.getElementById('start-btn');
    const downloadCsvBtn = document.getElementById('download-csv-btn');
    const statusConsole = document.getElementById('status-console');
    const welcomeMat = document.getElementById('welcome-mat');
    const dashboard = document.getElementById('dashboard');
    const fileDropArea = document.getElementById('file-drop-area');
    const fileUpload = document.getElementById('file-upload');
    const fileNameDisplay = document.getElementById('file-name-display');

    // --- Utility Functions ---
    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    function logToConsole(message, type = 'info') {
        const p = document.createElement('p');
        p.innerHTML = `<span class="text-gray-500">${new Date().toLocaleTimeString()}:</span> <span class="${type === 'error' ? 'text-red-400' : 'text-amber-300'}">> ${message}</span>`;
        statusConsole.appendChild(p);
        statusConsole.scrollTop = statusConsole.scrollHeight;
    }
    
    // --- File Handling ---
    fileDropArea.addEventListener('click', () => fileUpload.click());
    fileDropArea.addEventListener('dragover', (e) => {
        e.preventDefault(); e.stopPropagation();
        fileDropArea.classList.add('border-indigo-400');
    });
    fileDropArea.addEventListener('dragleave', (e) => {
        e.preventDefault(); e.stopPropagation();
        fileDropArea.classList.remove('border-indigo-400');
    });
    fileDropArea.addEventListener('drop', (e) => {
        e.preventDefault(); e.stopPropagation();
        fileDropArea.classList.remove('border-indigo-400');
        const files = e.dataTransfer.files;
        if (files.length > 0) handleFile(files[0]);
    });
    fileUpload.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length > 0) handleFile(files[0]);
    });
    
    function handleFile(file) {
        fileNameDisplay.textContent = file.name;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                // This is the logic that transforms the input data on the fly.
                const rawData = JSON.parse(e.target.result);
                jsonData = {
                    assets: rawData.assets.map(asset => ({
                        "ip": asset.ip_address,
                        "host-name": asset.hostname,
                        "os-certainty": asset.os,
                        "vulnerabilities": asset.vulnerabilities.map(vuln => ({
                            "id": vuln.cve_id,
                            "title": vuln.title,
                            "severity": vuln.cvss_base_score,
                            "port": vuln.port,
                            "protocol": vuln.protocol,
                            "proof": vuln.description
                        }))
                    }))
                };
                logToConsole(`Successfully loaded and transformed ${file.name}.`, 'success');
            } catch (err) {
                logToConsole(`Error parsing JSON file: ${err.message}`, 'error');
                fileNameDisplay.textContent = "your_data.json (Embedded)";
                jsonData = compatibleJsonData; // Fallback to compatible mock data
            }
        };
        reader.readAsText(file);
    }

    // --- SIMULATED/MOCK Enrichment Functions ---
    async function mockEnrichIpInfo(ip) {
        if (ipCache[ip]) return ipCache[ip];
        await sleep(200 + Math.random() * 300);
        const mockResponses = {
            '198.51.100.24': { ip_geo_country: 'USA', ip_geo_city: 'New York', whois_org: 'TEST-NET-2', abuse_score: 10 },
            '203.0.113.50': { ip_geo_country: 'Germany', ip_geo_city: 'Frankfurt', whois_org: 'TEST-NET-3', abuse_score: 0 },
            '192.168.1.100': { ip_geo_country: 'Private', ip_geo_city: 'N/A', whois_org: 'Private Range', abuse_score: 0 },
        };
        const response = mockResponses[ip] || { ip_geo_country: 'Unknown', ip_geo_city: 'Unknown', whois_org: 'Unknown', abuse_score: 'N/A' };
        ipCache[ip] = response;
        return response;
    }

    async function mockEnrichCveInfo(cve) {
        if (cveCache[cve]) return cveCache[cve];
        await sleep(250 + Math.random() * 400);
        const mockResponses = {
            'CVE-2023-4567': { nvd_base_score: 7.5, nvd_severity: 'HIGH' },
            'CVE-2022-31813': { nvd_base_score: 5.3, nvd_severity: 'MEDIUM' },
            'CVE-2021-34527': { nvd_base_score: 8.8, nvd_severity: 'HIGH' }, // PrintNightmare
        };
        const response = mockResponses[cve] || { nvd_base_score: 'N/A', nvd_severity: 'N/A' };
        cveCache[cve] = response;
        return response;
    }

    // --- Main Application Logic ---
    startBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        startBtn.textContent = 'Processing...';
        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
        welcomeMat.classList.add('hidden');
        dashboard.classList.remove('hidden');
        downloadCsvBtn.classList.add('hidden');
        Object.values(charts).forEach(chart => chart.destroy());

        enrichedResults = [];
        statusConsole.innerHTML = '<p>> Starting enrichment process...<span class="blinking-cursor border-r-2 border-amber-300"></span></p>';
        const assets = jsonData.assets || [];
        logToConsole(`Found ${assets.length} assets to process.`);
        
        for (const asset of assets) {
            if (!asset.ip) continue; // Skip assets without an IP
            logToConsole(`Processing asset: ${asset.ip} (${asset['host-name']})`);
            const ip_enrichment = await mockEnrichIpInfo(asset.ip);

            for (const vuln of asset.vulnerabilities) {
                if (!vuln.id) continue; // Skip vulns without an ID
                logToConsole(`&nbsp;&nbsp;-> Enriching ${vuln.id}...`);
                const cve_enrichment = await mockEnrichCveInfo(vuln.id);

                enrichedResults.push({
                    asset_ip: asset.ip,
                    asset_hostname: asset['host-name'] || 'N/A',
                    asset_os: asset['os-certainty'] || 'N/A',
                    vuln_id: vuln.id,
                    vuln_title: vuln.title,
                    vuln_severity_original: vuln.severity,
                    vuln_port: vuln.port,
                    vuln_protocol: vuln.protocol,
                    ...ip_enrichment,
                    ...cve_enrichment
                });
            }
        }
        
        logToConsole('Enrichment complete. Generating dashboard...');
        await sleep(500);
        generateDashboard();
        
        startBtn.disabled = false;
        startBtn.textContent = 'Start Enrichment';
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        downloadCsvBtn.classList.remove('hidden');
        document.querySelector('#status-console .blinking-cursor')?.remove();
        logToConsole('Process finished. Dashboard is ready.');
    });

    // --- Charting and Dashboard ---
    function generateDashboard() {
        const df = enrichedResults;
        const severityCounts = df.reduce((acc, row) => {
            const severity = row.nvd_severity || 'N/A';
            acc[severity] = (acc[severity] || 0) + 1;
            return acc;
        }, {});
        const severityOrder = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'NONE', 'N/A'];
        const sortedSeverities = Object.entries(severityCounts).sort((a,b) => severityOrder.indexOf(a[0]) - severityOrder.indexOf(b[0]));

        charts.severityChart = new Chart(document.getElementById('severityChart'), {
            type: 'doughnut',
            data: {
                labels: sortedSeverities.map(s => s[0]),
                datasets: [{ label: 'Count', data: sortedSeverities.map(s => s[1]), backgroundColor: ['#ef4444', '#f97316', '#facc15', '#a3e635', '#4ade80', '#9ca3af'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Vulnerabilities by NVD Severity', color: '#e5e7eb', font: {size: 16} }, legend: { position: 'right', labels: { color: '#d1d5db' } } } }
        });

        const cveCounts = df.reduce((acc, row) => { acc[row.vuln_id] = (acc[row.vuln_id] || 0) + 1; return acc; }, {});
        const topCves = Object.entries(cveCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
        charts.topCvesChart = new Chart(document.getElementById('topCvesChart'), {
            type: 'bar',
            data: {
                labels: topCves.map(c => c[0]),
                datasets: [{ label: 'Count', data: topCves.map(c => c[1]), backgroundColor: 'rgba(99, 102, 241, 0.7)' }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Top 10 Vulnerabilities', color: '#e5e7eb', font: {size: 16} }, legend: { display: false } }, scales: { x: { ticks: { color: '#d1d5db' }, grid: { color: '#4b5563' } }, y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } } } }
        });
        
        const assetCounts = df.reduce((acc, row) => { acc[row.asset_ip] = (acc[row.asset_ip] || 0) + 1; return acc; }, {});
        const topAssets = Object.entries(assetCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
         charts.topAssetsChart = new Chart(document.getElementById('topAssetsChart'), {
            type: 'bar',
            data: {
                labels: topAssets.map(c => c[0]),
                datasets: [{ label: 'Vulnerability Count', data: topAssets.map(c => c[1]), backgroundColor: 'rgba(34, 197, 94, 0.7)' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Top 10 Vulnerable Assets', color: '#e5e7eb', font: {size: 16} }, legend: { display: false } }, scales: { x: { ticks: { color: '#d1d5db' }, grid: { color: '#4b5563' } }, y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } } } }
        });

        const portCounts = df.reduce((acc, row) => { acc[row.vuln_port] = (acc[row.vuln_port] || 0) + 1; return acc; }, {});
        const topPorts = Object.entries(portCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
        charts.topPortsChart = new Chart(document.getElementById('topPortsChart'), {
            type: 'bar',
            data: {
                labels: topPorts.map(c => c[0]),
                datasets: [{ label: 'Count', data: topPorts.map(c => c[1]), backgroundColor: 'rgba(217, 70, 239, 0.7)' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Top 10 Vulnerable Ports', color: '#e5e7eb', font: {size: 16} }, legend: { display: false } }, scales: { x: { ticks: { color: '#d1d5db' }, grid: { color: '#4b5563' } }, y: { ticks: { color: '#d1d5db' }, grid: { color: '#374151' } } } }
        });
    }
    
    // --- CSV Export ---
    function convertToCSV(data) {
        if (data.length === 0) return '';
        const headers = Object.keys(data[0]);
        const csvRows = [headers.join(',')];
        for (const row of data) {
            const values = headers.map(header => `"${(''+row[header]).replace(/"/g, '""')}"`);
            csvRows.push(values.join(','));
        }
        return csvRows.join('\n');
    }

    downloadCsvBtn.addEventListener('click', () => {
        const csvContent = convertToCSV(enrichedResults);
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'enriched_security_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    });

</script>
</body>
</html>
